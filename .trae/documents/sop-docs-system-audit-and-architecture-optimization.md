## 关键约束（按你反馈修订）
- Token 压缩以“准确传达 + 执行效果优先”为第一原则。
- 仅在**不影响语义**的前提下压缩；如果压缩会降低可执行性/可审查性/歧义消解能力，则**不改**，甚至允许**适度增加** token 来换取更准确的约束表达。

## 你要的交付物（最终落盘）
- 错误清单 + 修复优先级（文件级→模块级→系统级分组）
- 重构后引用拓扑图（Graphviz DOT + Mermaid）
- “LLM 友好版”精简目录（单入口、≤3 跳可达、渐进式披露）
- Prompt 优化实验报告（包含 token/字符变化、以及“不压缩/增补”的理由）
- 单元测试用例：验证所有内部路径仍可访问 + 最大引用深度≤3

## 已发现的立即风险（只读扫描）
- `04_reference/index.md` 存在绝对 `file:///` 链接（可移植性差）。
- `scripts/sop-lint.mjs` prompts 扫描路径与当前目录结构不一致（覆盖缺口）。
- `docs/参考/sop` 当前无 `.txt/.json` 文件（主要为 `.md`，另有少量 `.csv/.gitkeep`）。

## 审计与优化方法（三级递进）
### 1) 文件级
- 校验：事实准确性、流程闭环性、层级边界清晰度（渐进式披露：父级仅摘要+链接）。
- 抽取：所有内部引用（md/csv）、外链、图片引用、代码块内显式路径。

### 2) 模块级
- 以目录为模块（02/03/04/05/prompts/skills/reviews），检查：
  - 是否存在双源 SSOT、重复定义、跨模块穿透引用
  - 入口与索引是否完整覆盖必须落盘交付物

### 3) 系统级
- 构建全量引用图，计算：
  - 从单一入口（默认 `01_concept_overview.md`，另报告 `AGENT_SOP.md`）出发的可达性
  - 每节点最短跳数、最大深度、孤岛、循环
- 目标：从“单一入口”出发所有节点最短路径 ≤3（必要时通过补充索引链接实现最短路径收敛）。

## 静态分析与测试实现（你确认后我会写代码并运行）
### A) 静态分析脚本
- 扩展 `scripts/sop-lint.mjs`：
  - 修正 prompts 扫描为 `docs/参考/sop/prompts/packs/**`
  - 增加 link 扫描与深度校验的入口（复用同一解析器）
- 新增 `scripts/sop-link-graph.mjs`：输出 link 可达性报告 + DOT/Mermaid 拓扑图。

### B) 结构改造以满足≤3跳
- 修复绝对路径引用为相对引用。
- 增加 `docs/参考/sop/LLM_INDEX.md`（或 `00_llm_index.md`）：
  - 只写“什么时候需要加载哪个模块”+ 每模块 1-2 行摘要 + 直达链接
  - 确保最短路径 ≤3，且不复制正文（坚持渐进式披露）。

### C) Prompt 优化实验（“准确优先”，压缩为次要目标）
- 目标对象：`docs/参考/sop/prompts/packs/default/**`。
- 对每个 prompt 文件做三分流：
  - **压缩**：可安全去冗余/去嵌套/去停用词且语义不变
  - **保持**：压缩会引入歧义或降低执行效果
  - **增补**：为消歧/补齐硬门槛而必要的补充
- 度量与证据：
  - 记录字符数与近似 token（chars/4 + 空白分词双指标）
  - 记录“关键约束要素清单”是否保留（MUST/禁止/仅当/停止点/落盘/SSOT 引用/路径）
- 达标口径：
  - **系统级目标**：尽量达到整体 ≥20% token/字符减少
  - **允许例外**：任何不达标或增补必须在报告中给出“准确性/效果”理由。

### D) 单元测试（Vitest）
- 新增 `tests/sop-links.test.ts`：
  - 校验内部链接目标存在
  - 校验从入口的最短路径深度 ≤3

## 报告归档目录
- 新建：`docs/参考/sop/reviews/<today>_system_audit_v2/`，包含：范围、事实核对、问题清单、link 检查、拓扑图、prompt 优化报告、LLM 精简目录。

## 验收标准
- 单元测试通过：所有内部引用可达；入口最短路径深度 ≤3。
- 报告完整：错误清单/优先级/拓扑图/LLM 精简目录/Prompt 优化对照与理由齐全。
- Prompt 优化符合“准确传达与效果优先”，压缩仅在不伤语义时进行。