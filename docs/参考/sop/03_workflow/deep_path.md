# 深度路径 (Deep Path)

**一句话定义**：适用于跨文件、新功能、重构等复杂变更的完整设计和实现流程。

---

## 适用场景

### ✅ 推荐使用
- **跨文件变更**：涉及多个文件的修改
- **新功能开发**：新增业务功能
- **代码重构**：改善代码结构和质量
- **API 变更**：接口的增加、修改或删除
- **系统架构调整**：架构层面的重大变更

### ❌ 不适用场景
- 单文件小范围修改
- 纯文档更新
- 配置微调

---

## 处理流程

### 新项目/大重构流程

```
Analyst → Prometheus ↔ Skeptic (多轮审查) → Oracle → Worker → Librarian
  需求    架构设计      架构审查          实现设计    编码实现    文档维护
```

**各阶段说明**：
1. **Analyst**: 通过对话挖掘需求，生成 PRD，多维度分析，用户确认
2. **Prometheus**: 基于 PRD 进行架构设计
3. **Skeptic**: 审查架构设计，多轮挑刺-回复循环
4. **Oracle**: 基于架构设计进行实现设计
5. **Worker**: 按设计编码实现
6. **Librarian**: 维护文档索引

**审查循环说明**：
- Prometheus 完成架构设计后，Skeptic 进行审查
- Skeptic 提出问题，Prometheus 回复并修正
- 循环继续，直到：
  - 设计已完善（Skeptic 无重大问题）
  - 需要用户决策（陷入僵局或 Prometheus 无法回复）

### 功能迭代流程

```
Analyst → Oracle → Worker → Librarian
  需求    实现设计   编码实现   文档维护
```

**说明**：功能迭代通常不需要完整的架构设计，Analyst 生成 PRD 后直接进入实现设计

### 文档更新流程

```
Explorer → Prometheus/Oracle → Librarian
  审计       设计文档编写        文档维护
```

---

## 详细步骤

### 阶段 1: 需求分析 (Analyst)

**职责**：通过对话挖掘需求，生成 PRD，多维度分析

**工作内容**：
- **对话挖掘**：与用户多轮对话，澄清需求
  - 了解业务背景和目标
  - 明确功能范围和边界
  - 探索潜在需求和约束
- **生成 PRD**：编写结构化需求文档
  - 需求概述和目标
  - 业务分析和用户分析
  - 功能需求和非功能需求
- **多维度分析**：从6个维度分析需求
  - 业务维度：业务价值、流程、规则
  - 用户维度：用户画像、场景、痛点
  - 功能维度：功能范围、优先级、依赖
  - 技术维度：可行性、约束、集成
  - 风险维度：不确定性、风险、缓解措施
  - 验收维度：验收标准、成功指标
- **需求验证**：与用户确认需求理解

**输出**：
- PRD 需求文档 (`docs/01_requirements/[feature]_prd.md`)
- 多维度需求分析报告
- 用户确认记录

**停止点**：`[WAITING FOR REQUIREMENTS APPROVAL]`

---

### 阶段 2: 审计 (Explorer)

**职责**：代码审计与影响评估

**说明**：此阶段可选，主要用于涉及代码变更的任务。Analyst 已完成需求分析，Explorer 在此基础上分析代码影响。

**工作内容**：
- 定位节点，分析调用链
- 识别模块间依赖关系
- 评估变更的影响范围
- 识别潜在风险点

**输出**：
- 代码审计报告
- 影响评估分析
- 风险提示

**停止点**：复述意图与影响面，待用户确认

---

### 阶段 3: 架构设计 (Prometheus)

**职责**：技术无关的架构设计

**工作内容**：
- 设计系统架构和模块关系
- 编写结构化伪代码
- 定义跨模块接口规范
- 记录架构决策 (ADR)

**输出**：
- 架构设计文档 (`docs/02_logical_workflow/*.pseudo`)
- 接口规范定义
- 架构决策记录

**停止点**：`[WAITING FOR ARCHITECTURE APPROVAL]`

---

### 阶段 4: 架构审查 (Skeptic)

**职责**：审查架构设计，发现问题和风险

**工作内容**：
- 多维度审查（完整性、一致性、可实现性、性能、安全、扩展性）
- 提出质疑和改进建议
- 评估 Prometheus 的回复

**输出**：
- 审查报告（含问题列表和改进建议）
- 审查结论（继续循环/进入下一阶段/需用户决策）

**循环流程**：
```
第1轮：Skeptic 审查 → Prometheus 回复 → Skeptic 评估
第2轮：Skeptic 再审查 → Prometheus 再回复 → Skeptic 评估
...
直到满足终止条件
```

**终止条件**：
- **正常终止**：设计已完善，无重大问题
- **异常终止**：
  - Prometheus 3次无法回复质疑
  - Skeptic 和 Prometheus 陷入僵局
  - 需要用户介入决策

**停止点**：
- 正常：`[ARCHITECTURE REVIEW PASSED]`
- 异常：`[WAITING FOR USER DECISION ON ARCHITECTURE]`

---

### 阶段 5: 实现设计 (Oracle)

**职责**：基于架构的具体实现设计

**工作内容**：
- 将架构设计映射到具体实现
- 技术选型和方案对比
- 任务分解和优先级排序
- 风险评估和缓解措施

**输出**：
- 实现设计文档 (`src/**/design.*`)
- 详细任务清单
- 技术决策记录

**停止点**：`[WAITING FOR DESIGN APPROVAL]`

---

### 阶段 6: 编码实现 (Worker)

**职责**：物理编码和质量保证

**工作内容**：
- 建立代码检查点
- 按设计实施编码
- 编写和运行测试
- 执行质量检查

**输出**：
- 实现代码
- 测试用例
- 质量检查报告

**停止点**：展示 Diff 待审

---

### 阶段 7: 文档维护 (Librarian)

**职责**：文档索引和渐进披露维护

**工作内容**：
- 更新父级文档摘要
- 维护文档间关联
- 确保渐进披露结构
- 归档完成的文档

**输出**：
- 更新的文档索引
- 维护的链接关系
- 归档的完成文档

---

## 质量控制

### 三错即停机制

所有深度路径都遵循三错即停机制：

**Strike 1**: 分析报错，执行逻辑修正
**Strike 2**: 停止编码，Explorer 审计环境，Oracle 微调方案
**Strike 3**: **熔断** - Supervisor 介入，生成报告，等待决策

👉 [查看三错即停详情](./three_strike_rule.md)

---

## 时间预估

| 任务类型 | 预计时间 | 主要阶段 |
|----------|----------|----------|
| 新增功能 | 2-4天 | Analyst 4h + Explorer 2h + Prometheus 4h + Skeptic 2h + Oracle 4h + Worker 1-2d + Librarian 2h |
| 代码重构 | 2-5天 | Analyst 2h + Explorer 4h + Prometheus 4h + Skeptic 4h + Oracle 8h + Worker 2-4d + Librarian 4h |
| 架构调整 | 1-2周 | Analyst 1d + Explorer 1d + Prometheus 2d + Skeptic 1d + Oracle 2d + Worker 4-8d + Librarian 1d |
| API 变更 | 3-7天 | Analyst 2h + Explorer 4h + Prometheus 4h + Skeptic 4h + Oracle 8h + Worker 2-5d + Librarian 4h |

**注意**：
- Analyst 的时间取决于需求复杂度，简单需求 2h，复杂需求 1d
- Skeptic 的时间为审查循环的总时间，实际时间取决于审查轮次

---

## 停止点汇总

| 阶段 | 停止点 | 等待内容 |
|------|--------|----------|
| Analyst | 需求分析完成 | `[WAITING FOR REQUIREMENTS APPROVAL]` |
| Explorer | 审计完成 | 用户确认意图与影响面 |
| Prometheus | 架构设计完成 | `[WAITING FOR ARCHITECTURE APPROVAL]` |
| Skeptic | 审查完成 | 正常：`[ARCHITECTURE REVIEW PASSED]` / 异常：`[WAITING FOR USER DECISION ON ARCHITECTURE]` |
| Oracle | 实现设计完成 | `[WAITING FOR DESIGN APPROVAL]` |
| Worker | 编码完成 | 展示 Diff 待审 |

---

## 质量标准

### 架构设计质量
- **技术无关**：不绑定特定技术栈
- **高内聚低耦合**：模块职责清晰
- **可扩展性**：考虑未来功能扩展
- **可测试性**：设计易于验证和测试

### 实现设计质量
- **完整性**：覆盖架构设计的所有要求
- **可操作性**：任务清单具体可执行
- **一致性**：与架构设计保持一致
- **可追溯**：明确引用架构设计文档

### 代码实现质量
- **准确性**：严格按照设计文档实现
- **可读性**：代码清晰，注释充分
- **健壮性**：具体异常捕获，资源安全释放
- **可测试性**：便于单元测试和集成测试

---

## 常见误区

### ❌ 避免
- 跳过架构设计直接编码
- 架构设计过于具体，绑定技术实现
- 实现设计偏离架构设计原则
- 忽视测试覆盖率和质量检查

### ✅ 推荐
- 严格按照流程执行每个阶段
- 架构设计保持技术无关性
- 实现设计忠实于架构设计
- 充分测试，确保质量

---

## 决策检查点

在开始深度路径前，确认以下问题：

- [ ] 是否涉及多个文件？
- [ ] 是否需要架构层面的设计？
- [ ] 是否有复杂的依赖关系？
- [ ] 是否需要技术选型决策？
- [ ] 是否需要详细的任务分解？

如果以上任一条件满足，请使用深度路径。

---

👉 [返回工作流总览](./index.md)  
👉 [查看快速路径](./fast_path.md)
