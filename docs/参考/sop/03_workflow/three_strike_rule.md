# 三错即停机制 (3-Strike Rule)

**一句话定义**：Worker 在编码过程中连续失败三次时触发的熔断机制，用于保护代码质量和防止无效工作。

---

## 机制概述

三错即停是一种质量控制机制，确保在编码出现问题时能够及时发现并采取措施，避免无效工作和代码质量下降。

```
Strike 1 → Strike 2 → Strike 3 (熔断)
  修正       审计       停止
```

---

## 详细流程

### Strike 1: 初次失败

**触发条件**：
- Worker 编码过程中遇到错误
- 测试未通过
- 质量检查发现问题

**处理动作**：
- 分析报错信息
- 定位问题根源
- 执行逻辑修正

**权限状态**：
- 继续编码权限
- 可以重试实现

**时间限制**：
- 建议在 30 分钟内解决
- 超时则升级到 Strike 2

---

### Strike 2: 二次失败

**触发条件**：
- Strike 1 修正后仍然失败
- 问题复杂度超出预期
- 需要重新审视设计方案

**处理动作**：
- **立即停止编码**
- **Explorer 审计环境**
  - 重新分析代码结构
  - 识别潜在问题
  - 评估影响范围
- **Oracle 微调方案**
  - 重新审视实现设计
  - 调整技术方案
  - 更新任务清单

**权限状态**：
- 暂停编码权限
- 等待方案调整后继续

**时间限制**：
- 建议在 2 小时内完成审计和方案调整
- 超时则升级到 Strike 3

---

### Strike 3: 熔断

**触发条件**：
- Strike 2 调整后仍然失败
- 发现严重设计缺陷
- 任务复杂度远超预期
- 存在不可逾越的技术障碍

**处理动作**：
- **Supervisor 介入**
  - 触发熔断机制
  - 暂停所有相关工作
  - 收集各方反馈
- **生成失败报告**
  - 记录失败原因
  - 分析方案回放
  - 推断瓶颈所在
- **等待用户决策**
  - 向用户报告情况
  - 提供决策建议
  - 等待用户指示

**权限状态**：
- 停止所有工具调用
- 锁定所有角色权限
- 等待人工干预

---

## 熔断恢复机制

### 恢复条件

- 用户明确指示继续
- 方案调整完成
- 风险因素消除
- 错误计数器重置

### 恢复流程

1. **用户决策**
   - 用户评估失败报告
   - 确定下一步行动
   - 给出明确指示

2. **方案调整**
   - 根据用户决策调整方案
   - 更新设计文档
   - 重新分配任务

3. **重置计数器**
   - 清除错误计数
   - 恢复角色权限
   - 重新开始工作

4. **继续执行**
   - 按照新方案执行
   - 加强监控和检查
   - 及时报告进展

---

## Supervisor 的熔断职责

### 触发条件监控

Supervisor 持续监控以下指标：

- **Worker 失败次数**：连续失败计数
- **任务超时情况**：是否超出预估时间
- **代码质量下降**：质量指标是否恶化
- **依赖冲突严重程度**：是否存在严重冲突

### 熔断动作

当触发条件满足时，Supervisor 执行：

1. **立即暂停**：停止当前所有工作
2. **收集反馈**：从 Explorer 和 Librarian 收集信息
3. **生成报告**：创建详细的失败分析报告
4. **用户协调**：向用户寻求决策方向

### 决策层级

- **轻度警告**：记录风险，继续执行
- **中度干预**：暂停执行，寻求确认
- **重度熔断**：立即停止，生成报告

---

## 失败报告模板

```markdown
# 失败分析报告

## 基本信息
- **任务**: [任务描述]
- **触发时间**: [时间]
- **触发角色**: [Worker/Explorer/Oracle]
- **失败次数**: 3/3 (熔断)

## 失败经过

### Strike 1
- **时间**: [时间]
- **问题**: [问题描述]
- **处理**: [处理措施]
- **结果**: 失败

### Strike 2
- **时间**: [时间]
- **审计发现**: [Explorer 的发现]
- **方案调整**: [Oracle 的调整]
- **结果**: 失败

### Strike 3 (熔断)
- **时间**: [时间]
- **最终问题**: [问题描述]

## 问题分析

### 根本原因
[根本原因分析]

### 瓶颈所在
[瓶颈分析]

### 影响范围
[影响范围评估]

## 建议方案

### 方案 A
[方案描述]
- **优点**: [优点]
- **缺点**: [缺点]

### 方案 B
[方案描述]
- **优点**: [优点]
- **缺点**: [缺点]

## 决策请求

请用户选择：
- [ ] 采用方案 A 继续
- [ ] 采用方案 B 继续
- [ ] 重新设计
- [ ] 暂停任务
- [ ] 其他：[请描述]
```

---

## 预防措施

### 设计阶段
- 充分的需求分析
- 合理的方案设计
- 详细的风险评估

### 实现阶段
- 渐进式开发
- 频繁的测试验证
- 及时的问题反馈

### 监控阶段
- 实时的进度跟踪
- 质量的持续检查
- 风险的早期预警

---

## 常见误区

### ❌ 避免
- 忽视早期警告信号
- 强行继续失败的工作
- 不及时报告问题
- 跳过审计和方案调整

### ✅ 推荐
- 及时识别和处理问题
- 严格按照机制执行
- 充分沟通和报告
- 从失败中学习和改进

---

## 快速参考

| 阶段 | 触发条件 | 处理动作 | 权限状态 |
|------|----------|----------|----------|
| Strike 1 | 初次失败 | 分析修正 | 继续编码 |
| Strike 2 | 二次失败 | 审计+调整 | 暂停编码 |
| Strike 3 | 三次失败 | 熔断+报告 | 停止所有 |

---

👉 [返回工作流总览](./index.md)
