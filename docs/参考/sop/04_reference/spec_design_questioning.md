---
version: v2.5.0
updated: 2026-02-22
---

# Spec 设计阶段交互式提问指南

本文档定义 Spec 设计阶段（L2/L3）的交互式提问机制，确保设计决策与现有架构、ADR、约束矩阵保持一致。适用于 `sop-architecture-design` 和 `sop-implementation-designer` 在设计过程中与用户的交互场景。

---

## 1. 提问触发机制

### 1.1 章节级检测时机

| 设计阶段 | 检测节点 | 触发条件 |
|----------|----------|----------|
| **L2 架构设计** | 技术选型章节 | 引入新依赖/框架/服务 |
| **L2 架构设计** | 接口定义章节 | 定义跨模块接口/公共 API |
| **L2 架构设计** | 数据流章节 | 涉及数据存储/传输变更 |
| **L3 实现设计** | 技术规格章节 | 具体技术实现方案选择 |
| **L3 实现设计** | 接口契约章节 | 函数签名/数据结构定义 |

### 1.2 检测范围

```
检测范围
├── ADR 文档 (docs/04_context_reference/adr_*.md)
│   ├── 已接受决策 → 强制合规
│   ├── 提议中决策 → 需确认一致性
│   └── 已废弃决策 → 检查是否重新激活
├── 设计文档 (docs/02_logical_workflow/*.md)
│   ├── 架构边界定义
│   └── 模块职责划分
└── 约束矩阵 (docs/05_constraints/*.md)
    ├── 安全红线
    ├── 性能基线
    └── 兼容性要求
```

### 1.3 即时提问流程

```
设计过程
    ↓
【检测点】章节内容变更
    ↓
【扫描】ADR/设计文档/约束矩阵
    ↓
【判断】是否存在冲突/歧义/缺失？
    ├─ 否 → 继续设计
    └─ 是 → 【触发提问】
              ↓
         【格式化提问】
              ↓
         【等待用户响应】
              ↓
         【处理响应】
              ├─ 确认 → 更新设计/ADR
              ├─ 拒绝 → 回滚/调整方案
              └─ 补充信息 → 重新评估
```

---

## 2. 冲突优先级处理

### 2.1 按影响范围排序规则

| 优先级 | 影响范围 | 冲突类型 | 处理时限 |
|--------|----------|----------|----------|
| **P0** | 系统级 | 安全红线/数据丢失风险 | 立即阻断 |
| **P1** | 模块级 | 架构边界/接口兼容性 | 当前章节完成前 |
| **P2** | 功能级 | 性能/可维护性影响 | 设计阶段结束前 |
| **P3** | 代码级 | 实现细节/风格问题 | 可延后至实现阶段 |

### 2.2 多冲突处理流程

```markdown
## 冲突处理流程

### 步骤1：冲突收集
当检测到多个冲突时，按优先级排序并汇总：

| 序号 | 优先级 | 冲突描述 | 影响范围 | 相关文档 |
|------|--------|----------|----------|----------|
| 1 | P0 | [描述] | [范围] | [链接] |
| 2 | P1 | [描述] | [范围] | [链接] |

### 步骤2：批量提问
按优先级从高到低，一次提问一个冲突，等待解决后再处理下一个。

### 步骤3：影响链分析
解决高优先级冲突后，检查是否影响低优先级冲突：
- 若已解决 → 标记为"已连带解决"
- 若仍存在 → 继续处理
- 若加剧 → 提升优先级重新评估
```

---

## 3. 提问格式规范

### 3.1 结构化选项要求

```markdown
## 设计确认请求

### 检测到的冲突/问题
**类型**: [冲突类型]
**位置**: [设计文档章节]
**描述**: [具体问题描述]

### 相关约束/决策
> 引用: [ADR-XXX](../04_context_reference/adr_xxx.md) 或 [约束文档](../05_constraints/xxx.md)
> 要求: [约束/决策的具体要求]

### 当前设计内容
[展示当前设计的相关部分]

### 请选择处理方式
- **A. [方案名称]**: [方案描述]
  - 影响: [对现有系统的影响]
  - 风险: [潜在风险]
  
- **B. [方案名称]**: [方案描述]
  - 影响: [对现有系统的影响]
  - 风险: [潜在风险]
  
- **C. 自定义方案**: 请描述您的方案

**推荐**: [A/B] (理由: [推荐理由])
```

### 3.2 选项设计原则

| 原则 | 说明 | 示例 |
|------|------|------|
| **完整性** | 选项应覆盖主要可行方案 | 不遗漏明显合理的选项 |
| **互斥性** | 各选项之间应相互独立 | 避免选项A包含选项B |
| **可比较性** | 选项应使用相同的评估维度 | 都包含影响/风险/成本 |
| **可操作性** | 每个选项应可直接执行 | 不需要额外解释 |
| **默认推荐** | 提供基于最佳实践的推荐 | 标注推荐选项及理由 |

---

## 4. ADR 确认更新机制

### 4.1 展示更新内容预览

当设计决策需要更新现有 ADR 时，按以下格式展示：

```markdown
## ADR 更新确认

### 目标 ADR
**文档**: [ADR-XXX: 标题](../04_context_reference/adr_xxx.md)
**当前状态**: [已接受/提议中]

### 变更预览
| 章节 | 变更前 | 变更后 |
|------|--------|--------|
| [章节名] | [原内容] | [新内容] |
| [章节名] | [原内容] | [新内容] |

### 变更原因
[说明为什么需要此变更]

### 影响评估
- **影响范围**: [受影响的模块/系统]
- **兼容性**: [是否向后兼容]
- **迁移成本**: [需要的迁移工作]

### 请确认
- **确认更新**: 同意更新 ADR，继续设计
- **拒绝更新**: 保持原 ADR，调整设计方案
- **创建新 ADR**: 保留原 ADR，创建新的 ADR 记录此决策
```

### 4.2 用户确认/拒绝处理

| 用户响应 | 处理动作 | 后续步骤 |
|----------|----------|----------|
| **确认更新** | 更新 ADR 文档 | 继续设计，记录变更日志 |
| **拒绝更新** | 回滚设计变更 | 重新设计方案以符合现有 ADR |
| **创建新 ADR** | 创建新 ADR 文档 | 新 ADR 引用原 ADR，说明替代关系 |
| **请求讨论** | 暂停设计流程 | 进入讨论模式，记录讨论结论 |

---

## 5. 决策分级记录

### 5.1 决策分级标准

| 级别 | 判定条件 | 记录位置 | 记录格式 |
|------|----------|----------|----------|
| **重要决策** | 引入新依赖/变更架构/影响安全/影响多模块 | ADR | 完整 ADR 格式 |
| **一般决策** | 单模块实现方案/接口设计/数据结构 | spec.md | 决策记录章节 |
| **轻微决策** | 代码风格/命名规范/工具选择 | 代码注释 | 简要说明 |

### 5.2 记录格式示例

#### 重要决策 → ADR 格式

```markdown
# ADR-[模块]-[序号]: [决策标题]

## 状态
- [x] 已接受

## 背景
[问题背景和约束条件]

## 决策
[选择的方案]

## 选项对比
| 选项 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| 选项A | ... | ... | ✅ 选择 |
| 选项B | ... | ... | ❌ 放弃 |

## 影响
- 正面: [影响]
- 负面: [影响及缓解措施]
```

#### 一般决策 → spec.md 格式

```markdown
## 决策记录

### [决策主题]
- **决策时间**: [日期]
- **决策内容**: [具体决策]
- **决策理由**: [简要理由]
- **影响范围**: [受影响范围]
- **相关 ADR**: [ADR 链接，如有]
```

---

## 6. 提问角度检查清单

### 6.1 检查清单

设计过程中，按以下角度逐一检查是否需要提问：

#### 架构一致性

- [ ] 设计是否符合现有架构分层？
- [ ] 模块边界是否清晰？
- [ ] 依赖方向是否正确（单向/无循环）？
- [ ] 是否引入新的跨层调用？

#### ADR 合规性

- [ ] 是否与已接受的 ADR 冲突？
- [ ] 是否需要更新现有 ADR？
- [ ] 是否需要创建新 ADR？
- [ ] 是否复用已废弃 ADR 的场景？

#### 性能影响

- [ ] 是否影响关键路径性能？
- [ ] 是否引入新的性能瓶颈？
- [ ] 是否需要性能基准测试？
- [ ] 数据量增长对性能的影响？

#### 安全风险

- [ ] 是否涉及敏感数据处理？
- [ ] 是否引入新的攻击面？
- [ ] 是否符合安全红线要求？
- [ ] 权限控制是否完备？

#### 可维护性

- [ ] 代码复杂度是否可控？
- [ ] 是否便于单元测试？
- [ ] 是否便于后续扩展？
- [ ] 文档是否完整？

#### 兼容性

- [ ] 是否影响现有接口兼容性？
- [ ] 是否需要数据迁移？
- [ ] 是否影响第三方集成？
- [ ] 版本升级策略是否明确？

### 6.2 检查结果处理

```markdown
## 设计检查结果

### 检查时间
[日期时间]

### 检查结果汇总
| 检查角度 | 状态 | 问题数 | 说明 |
|----------|------|--------|------|
| 架构一致性 | ✅/⚠️/❌ | N | [说明] |
| ADR 合规性 | ✅/⚠️/❌ | N | [说明] |
| 性能影响 | ✅/⚠️/❌ | N | [说明] |
| 安全风险 | ✅/⚠️/❌ | N | [说明] |
| 可维护性 | ✅/⚠️/❌ | N | [说明] |
| 兼容性 | ✅/⚠️/❌ | N | [说明] |

### 待解决问题
| 序号 | 角度 | 问题描述 | 优先级 |
|------|------|----------|--------|
| 1 | [角度] | [描述] | P0-P3 |

### 结论
- [ ] 检查通过，可继续设计
- [ ] 存在问题，需用户确认后继续
- [ ] 存在严重问题，需阻断并解决
```

---

## 7. 相关文档引用

| 文档 | 用途 | 关系 |
|------|------|------|
| [ADR 模板](document_templates/adr.md) | ADR 文档格式参考 | 提问涉及 ADR 时引用 |
| [ADR 审查标准](review_standards/adr.standard.md) | ADR 合规性检查标准 | 检查 ADR 合规性时使用 |
| [设计决策规则](design_decision_rules.md) | 设计决策判断规则 | 决策分级时参考 |
| [设计审查格式](interaction_formats/design_review.md) | 审查交互格式 | 审查阶段提问格式 |
| [来源与依赖声明](interaction_formats/source_dependency.md) | 来源依赖标准格式 | 提问时声明依据 |
| [文档目录映射](document_directory_mapping.md) | 文档层级与位置 | 确定文档位置时参考 |

---

## 8. 约束

1. **即时提问**：检测到冲突时必须立即提问，不得延后
2. **结构化选项**：提问必须提供结构化选项，不得仅开放问答
3. **证据引用**：提问必须引用相关 ADR/约束文档作为依据
4. **分级记录**：所有用户决策必须按分级标准记录
5. **检查清单**：每个设计章节完成后必须执行检查清单
6. **优先级遵守**：多冲突时必须按优先级顺序处理
