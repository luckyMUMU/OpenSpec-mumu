# ADR 模板 (L4: 决策参考)

**层级**: L4 - 决策参考  
**位置**: `docs/04_context_reference/adr_[模块]_[决策主题].md`  
**创建者**: Prometheus / Oracle  
**规范**: 记录关键架构/技术决策的背景和理由

---

## 文件结构

```markdown
# ADR-[编号]: [决策标题]

## 状态
- [ ] 提议
- [x] 已接受
- [ ] 已废弃
- [ ] 已替代 (被 ADR-XXX 替代)

## 背景 (Context)

### 问题描述
[需要解决什么问题？]

### 约束条件
- [约束1: 性能要求/技术限制/业务限制]
- [约束2]

### 影响范围
- [影响模块/系统]

## 决策 (Decision)

### 选择的方案
[方案名称/描述]

### 决策理由
[一句话核心理由]

## 选项对比 (Options Considered)

| 选项 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **选项A** (已选择) | [优点] | [缺点] | [场景] |
| 选项B | [优点] | [缺点] | [场景] |
| 选项C | [优点] | [缺点] | [场景] |

## 影响 (Consequences)

### 正面影响
- [影响1]
- [影响2]

### 负面影响/风险
- [风险1] → [缓解措施]
- [风险2] → [缓解措施]

### 技术债务
- [债务描述] → [偿还计划]

## 相关文档

- **L2 逻辑设计**: [链接到 .md 文件]
- **L3 实现设计**: [链接到 design.md]
- **相关 ADR**: [ADR-XXX]

## 决策记录

| 日期 | 决策人 | 动作 | 说明 |
|------|--------|------|------|
| [日期] | [姓名] | 创建 | [说明] |
| [日期] | [姓名] | 更新 | [说明] |
```

---

## ADR 编号规范

```
ADR-[模块]-[序号]: [标题]

示例:
ADR-Auth-001: 使用JWT替代Session
ADR-Order-002: 订单状态机设计
ADR-Cache-003: Redis集群方案选择
```

---

## 何时创建 ADR

✅ **需要创建**:
- 引入新的技术栈/框架
- 核心架构模式变更
- 重大接口设计决策
- 性能优化策略选择
- 安全方案决策

❌ **不需要创建**:
- 代码实现细节
- 纯bug修复
- 配置参数调整
- 文档更新

---

## L4 层约束

✅ **必须**:
- 记录决策背景 (Why)
- 对比多个选项
- 明确决策理由
- 说明影响和风险

❌ **禁止**:
- 重复描述 L2/L3 的技术细节
- 只有结论没有理由
- 遗漏负面影响的描述

---

## ADR 示例

### ADR-001: 用户认证方案选择

**状态**: 已接受

**背景**:
需要为用户系统设计认证机制，要求支持多端登录、Token刷新、权限控制。

**决策**: 使用 JWT (JSON Web Token) 替代传统 Session

**选项对比**:

| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| **JWT** | 无状态、易扩展、跨服务 | Token撤销困难、体积大 | ✅ 选择 |
| Session | 服务端可控、可立即撤销 | 有状态、需要共享存储 | ❌ 不选 |
| OAuth2 | 标准化、第三方集成 | 复杂度高、过度设计 | ❌ 不选 |

**理由**: 系统需要水平扩展，JWT 无状态特性更适合微服务架构。

**影响**:
- ✅ 服务无状态，易于扩展
- ⚠️ Token 撤销需额外机制（黑名单）
- ⚠️ Token 体积大，需控制 claims 数量

**缓解措施**:
- 实现 Token 黑名单服务
- Access Token 有效期设为 15 分钟
- Refresh Token 使用 Redis 存储便于撤销

---

## 与 L2/L3 的关系

| 层级 | 文件 | 内容 | 创建者 |
|------|------|------|--------|
| L2 | `.md` | 逻辑工作流 | Prometheus |
| L3 | `design.md` | 技术规格 | Oracle |
| L4 | `adr_*.md` | 决策背景 | Prometheus/Oracle |

👉 L2/L3 中的关键决策需在 L4 记录  
👉 L4 引用对应的 L2/L3 文档  
👉 L4 回答 "Why" 问题
