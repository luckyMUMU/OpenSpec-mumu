---
version: v2.6.0
updated: 2026-02-22
---

# ADR 模板 (L4: 决策参考)

**层级**: L4 - 决策参考  
**位置**: `docs/04_context_reference/adr_[模块]_[决策主题].md`  
**创建者**: sop-architecture-design / sop-implementation-designer  
**规范**: 记录关键架构/技术决策的背景和理由

---

## 文件结构

```markdown
# ADR-[编号]: [决策标题]

## 状态
- [ ] 提议
- [x] 已接受
- [ ] 已废弃
- [ ] 已替代 (被 ADR-XXX 替代)

## 0. 来源与依赖声明
> 必须引用 [Source and Dependency](04_reference/interaction_formats/source_dependency.md) 标准格式

## 背景 (Context)

### 问题描述
[需要解决什么问题？]

### 约束条件
- [约束1: 性能要求/技术限制/业务限制]
- [约束2]

### 影响范围
- [影响模块/系统]

## 决策 (Decision)

### 选择的方案
[方案名称/描述]

### 决策理由
[一句话核心理由]

## 选项对比 (Options Considered)

| 选项 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **选项A** (已选择) | [优点] | [缺点] | [场景] |
| 选项B | [优点] | [缺点] | [场景] |
| 选项C | [优点] | [缺点] | [场景] |

## 影响 (Consequences)

### 正面影响
- [影响1]
- [影响2]

### 负面影响/风险
- [风险1] → [缓解措施]
- [风险2] → [缓解措施]

### 技术债务
- [债务描述] → [偿还计划]

## 相关文档

- **L2 逻辑设计**: [链接到 .md 文件]
- **L3 实现设计**: [链接到 design.md]
- **相关 ADR**: [ADR-XXX]

## 决策记录

| 日期 | 变更类型 | 原决策 | 新决策 | 触发任务 | 决策人 | 说明 |
|------|----------|--------|--------|----------|--------|------|
| [日期] | 创建 | - | [初始决策] | [task-id] | [姓名] | [创建说明] |
| [日期] | 修改 | [原内容] | [新内容] | [change-id] | [姓名] | [变更说明] |
| [日期] | 废弃 | [原决策] | - | [task-id] | [姓名] | [废弃说明] |
```

---

## ADR 编号规范

```
ADR-[模块]-[序号]: [标题]

示例:
ADR-Auth-001: 使用JWT替代Session
ADR-Order-002: 订单状态机设计
ADR-Cache-003: Redis集群方案选择
```

---

## 何时创建 ADR

✅ **需要创建**:
- 引入新的技术栈/框架
- 核心架构模式变更
- 重大接口设计决策
- 性能优化策略选择
- 安全方案决策
- Spec 阶段检测到冲突时
- 用户决策需要持久化时

❌ **不需要创建**:
- 代码实现细节
- 纯bug修复
- 配置参数调整
- 文档更新

---

## L4 层约束

✅ **必须**:
- 记录决策背景 (Why)
- 对比多个选项
- 明确决策理由
- 说明影响和风险
- 决策变更必须记录
- 与 Spec 的关联必须声明

❌ **禁止**:
- 重复描述 L2/L3 的技术细节
- 只有结论没有理由
- 遗漏负面影响的描述

---

## 与 Spec 的关联

### Spec 任务触发 ADR 更新

当 Spec 任务执行过程中出现以下情况时，可能触发 ADR 更新：

1. **检测到决策冲突**: Spec 任务发现与现有 ADR 不一致的情况
2. **技术方案调整**: 实现过程中需要修改原定方案
3. **新约束发现**: 发现新的技术或业务约束

### ADR 更新流程

```
Spec 任务 → 检测冲突 → 提示用户确认 → 更新 ADR → 记录变更
```

### 决策记录格式

在"决策变更记录"章节中，使用以下格式记录变更：

| 字段 | 说明 | 示例 |
|------|------|------|
| 日期 | 变更发生日期 | 2026-02-22 |
| 变更类型 | 修改/新增/废弃 | 修改 |
| 原决策 | 变更前的决策内容 | 使用 Session 认证 |
| 新决策 | 变更后的决策内容 | 使用 JWT 认证 |
| 触发任务 | 触发变更的 Spec 任务 ID | change-20260222-001 |
| 决策人 | 做出决策的人员 | 张三 |

### 用户确认机制

ADR 更新必须经过用户确认：

- 系统检测到需要更新 ADR 时，应向用户展示变更内容
- 用户确认后方可更新 ADR 文档

**用户确认选项**：

| 选项 | 说明 | 系统行为 |
|------|------|----------|
| 更新现有 ADR | 同意更新当前 ADR 文档 | 执行更新，记录变更历史 |
| 创建新 ADR | 保留原 ADR，创建新文档 | 新建 ADR，原 ADR 标记为已替代 |
| 请求讨论 | 需要进一步讨论后再决定 | 暂停更新，等待用户后续确认 |
| 跳过更新 | 不进行任何更新操作 | Spec 任务调整方案或中止 |

---

## ADR 示例

### ADR-001: 用户认证方案选择

**状态**: 已接受

**背景**:
需要为用户系统设计认证机制，要求支持多端登录、Token刷新、权限控制。

**决策**: 使用 JWT (JSON Web Token) 替代传统 Session

**选项对比**:

| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| **JWT** | 无状态、易扩展、跨服务 | Token撤销困难、体积大 | ✅ 选择 |
| Session | 服务端可控、可立即撤销 | 有状态、需要共享存储 | ❌ 不选 |
| OAuth2 | 标准化、第三方集成 | 复杂度高、过度设计 | ❌ 不选 |

**理由**: 系统需要水平扩展，JWT 无状态特性更适合微服务架构。

**影响**:
- ✅ 服务无状态，易于扩展
- ⚠️ Token 撤销需额外机制（黑名单）
- ⚠️ Token 体积大，需控制 claims 数量

**缓解措施**:
- 实现 Token 黑名单服务
- Access Token 有效期设为 15 分钟
- Refresh Token 使用 Redis 存储便于撤销

---

## 与 L2/L3 的关系

| 层级 | 文件 | 内容 | 产出 Skill |
|------|------|------|--------|
| L2 | `.md` | 逻辑工作流 | sop-architecture-design |
| L3 | `design.md` | 技术规格 | sop-implementation-designer |
| L4 | `adr_*.md` | 决策背景 | sop-architecture-design / sop-implementation-designer |

👉 L2/L3 中的关键决策需在 L4 记录  
👉 L4 引用对应的 L2/L3 文档  
👉 L4 回答 "Why" 问题
