# SOP 流程禁止项矩阵（黑白名单）

> **版本**: v1.5.0  
> **更新日期**: 2026-02-11

---

## 概述

本文档使用**黑白名单**方式明确 SOP 流程中各角色、各阶段的**允许操作**（白名单）和**禁止操作**（黑名单）。

**使用方式**:
- ✅ **白名单**: 明确允许的操作
- ❌ **黑名单**: 明确禁止的操作
- ⚠️ **违反后果**: 说明违反约束的后果

---

## 1. 全局禁止项（所有角色通用）

### 1.1 状态管理约束

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **状态标记** | 先标记`[进行中]`，再执行操作 | 未标记状态直接修改文件 | 状态混乱，无法追踪进度 |
| **状态更新** | 完成后标记`[已完成]` | 未完成就标记`[已完成]` | 虚假进度，质量风险 |
| **父目录内容** | 只保留摘要+链接 | 在父目录放置详细内容 | 破坏渐进披露结构 |

### 1.2 文件操作约束

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **参考目录** | Librarian 维护 `/docs/参考/` | 非Librarian修改`/docs/参考/` | SOP标准被破坏 |
| **文档层级** | 按L1-L4层级创建文档 | 跳过层级或层级混乱 | 文档结构混乱 |
| **链接维护** | 及时更新文档间链接 | 保留无效链接 | 导航困难 |

### 1.3 流程约束

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **阶段顺序** | 按顺序完成各阶段 | 跳过必要阶段 | 质量风险，返工 |
| **停止点** | 在停止点等待确认 | 绕过停止点继续 | 决策失误 |
| **审查循环** | 最多3轮审查 | 超过3轮仍不通过 | 进入熔断 |

---

## 2. 角色特定禁止项

### 2.1 Router（调度员）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **任务分诊** | 分析复杂度，选择路径 | 不做分析直接分配 | 路径选择错误 |
| **角色分配** | 按规则分配角色 | 分配未授权角色 | 权限混乱 |
| **状态读取** | 读取全局状态 | 修改代码或文档 | 超出权限 |

### 2.2 Explorer（审计员）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **代码读取** | 搜索、读取、分析代码 | 修改任何代码 | 只读角色 |
| **影响评估** | 评估依赖和影响范围 | 不做评估直接报告 | 遗漏风险 |
| **文档读取** | 读取相关文档 | 修改文档内容 | 超出权限 |

### 2.3 Analyst（需求分析师）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **需求文档** | 创建PRD/MRD/FRD | 编写代码或设计 | 职责混淆 |
| **原型设计** | 创建UI原型 | 设计系统架构 | 超出职责 |
| **用户对话** | 多轮对话澄清需求 | 不与用户确认需求 | 理解偏差 |

### 2.4 Prometheus（架构师）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **架构设计** | 编写伪代码、接口定义 | 考虑具体技术实现 | 技术绑定 |
| **技术无关** | 保持技术无关性 | 使用特定语言语法 | 失去通用性 |
| **决策记录** | 记录架构决策(ADR) | 不做决策记录 | 决策不可追溯 |

### 2.5 Skeptic（审查员）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **审查** | 审查架构，提出问题 | 直接修改架构设计 | 职责混淆 |
| **反馈** | 写入审查意见 | 不提出任何问题 | 失去审查意义 |
| **循环** | 最多3轮审查 | 无限循环审查 | 效率低下 |

### 2.6 Oracle（实现设计师）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **实现设计** | 创建design.md | 直接编写代码 | 跳过设计阶段 |
| **技术选型** | 对比技术方案 | 不做方案对比 | 选型不合理 |
| **任务分解** | 分解可执行任务 | 任务粒度不清晰 | 执行困难 |

### 2.7 Tester（测试设计师）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **CSV维护** | 读写CSV测试用例 | 查看代码实现 | 失去独立性 |
| **测试设计** | 基于设计文档生成用例 | 基于代码生成用例 | 测试偏见 |
| **版本管理** | 管理CSV版本 | 不更新版本号 | 版本混乱 |

### 2.8 TestWorker（测试实现者）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **测试代码** | 读写测试代码 | 修改CSV用例 | 破坏唯一性 |
| **CSV读取** | 只读CSV用例 | 修改CSV任何内容 | 权限违规 |
| **问题报告** | 报告CSV问题给Tester | 自行修改CSV | 职责混淆 |

### 2.9 Worker（编码者）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **代码实现** | 按设计文档编写代码 | 修改设计内容（除“待处理变更”外） | 设计漂移 |
| **测试运行** | 运行测试验证 | 跳过测试直接提交 | 质量风险 |
| **质量检查** | 运行lint/type check | 忽略质量检查 | 代码质量问题 |
| **设计变更** | 发现设计问题报告Oracle | 自行修改设计方案 | 职责混淆 |

### 2.10 Supervisor（监管员）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **状态更新** | 更新任务状态 | 修改代码或文档 | 超出权限 |
| **熔断决策** | 触发熔断机制 | 忽视连续失败 | 资源浪费 |
| **报告生成** | 生成失败报告 | 不做任何记录 | 无法追溯 |

### 2.11 Librarian（图书管理员）

| 操作类型 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|----------|------------------|------------------|----------|
| **索引维护** | 更新文档索引（索引/摘要/链接） | 修改规范性正文与流程定义 | 职责混淆 |
| **链接检查** | 验证链接有效性 | 保留无效链接 | 导航困难 |
| **SOP维护** | 维护`/docs/参考/` | 其他角色修改SOP | 标准被破坏 |

---

## 3. 阶段特定禁止项

### 3.1 需求阶段（Analyst主导）

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **用户对话** | 多轮对话澄清需求 | 不与用户确认 | 理解偏差 |
| **文档创建** | 创建PRD/MRD/FRD | 开始编码 | 跳过设计 |
| **原型设计** | UI项目创建原型 | 非UI项目创建原型 | 资源浪费 |
| **停止点** | 等待`[WAITING_FOR_REQUIREMENTS]` | 绕过停止点 | 需求未确认 |

### 3.2 架构阶段（Prometheus ↔ Skeptic）

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **伪代码** | 编写技术无关伪代码 | 使用特定语言 | 技术绑定 |
| **审查循环** | 最多3轮审查 | 超过3轮 | 效率低下 |
| **决策记录** | 记录ADR | 不做记录 | 决策不可追溯 |
| **停止点** | 等待`[WAITING_FOR_ARCHITECTURE]` | 绕过停止点 | 架构未确认 |

### 3.3 实现设计阶段（Oracle主导）

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **技术选型** | 对比技术方案 | 不做对比直接选择 | 选型不合理 |
| **任务分解** | 分解可执行任务 | 任务粒度不清晰 | 执行困难 |
| **接口定义** | 定义详细接口 | 接口定义模糊 | 集成问题 |
| **停止点** | 等待`[WAITING_FOR_DESIGN]` | 绕过停止点 | 设计未确认 |

### 3.4 测试用例阶段（Tester主导，TDD路径）

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **基于设计** | 仅基于设计文档 | 参考代码实现 | 失去独立性 |
| **CSV格式** | 使用CSV格式 | 使用其他格式 | 不便于审核 |
| **版本管理** | 包含版本信息 | 无版本管理 | 版本混乱 |
| **停止点** | 等待`[WAITING_FOR_TEST_DESIGN]` | 绕过停止点 | 测试未审核 |

### 3.5 编码阶段（Worker + TestWorker）

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **按设计编码** | 严格按设计实现 | 偏离设计 | 设计漂移 |
| **测试先行** | 先写测试再写代码（TDD） | 先写代码后补测试 | 测试覆盖不足 |
| **质量检查** | 必须通过lint/type check | 忽略质量检查 | 代码质量问题 |
| **三错即停** | 3次失败触发熔断 | 无限重试 | 资源浪费 |

---

## 4. 文件类型禁止项

### 4.1 按文件类型

| 文件类型 | 白名单角色 | 黑名单角色 | 禁止操作 |
|----------|-----------|-----------|----------|
| **CSV测试用例** | Tester（读写） | TestWorker（只读） | TestWorker修改CSV |
| **测试代码** | TestWorker（读写） | Tester（只读） | Tester修改测试代码 |
| **SOP标准文档** | Librarian（读写） | 其他所有角色 | 非Librarian修改SOP |
| **架构文档(L2 .md)** | Prometheus（读写） | 其他角色 | 非Prometheus修改架构 |
| **需求文档** | Analyst（读写） | 其他角色 | 非Analyst修改需求 |
| **实现设计(design.md)** | Oracle（读写）；Worker（仅追加“待处理变更”） | 其他角色 | Worker修改除“待处理变更”外内容；非白名单角色修改任何内容 |

### 4.2 按目录位置

| 目录 | 白名单角色 | 黑名单角色 | 禁止操作 |
|------|-----------|-----------|----------|
| `/docs/参考/` | Librarian | 其他所有角色 | 任何修改 |
| `/docs/01_requirements/` | Analyst | 其他角色 | 非需求相关修改 |
| `/docs/02_logical_workflow/` | Prometheus | 其他角色 | 非架构相关修改 |
| `/docs/03_technical_spec/test_cases/` | Tester | 其他角色 | 非Tester修改CSV |
| `src/**/design.md` | Oracle；Worker（仅追加“待处理变更”） | 其他角色 | Worker修改除“待处理变更”外内容；非白名单角色修改任何内容 |

---

## 5. 路径特定禁止项

### 5.1 快速路径

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **适用范围** | 单文件+<30行+无逻辑变更 | 跨文件/新功能/重构 | 路径选择错误 |
| **流程** | Explorer → Worker → Librarian | 跳过Explorer | 影响评估缺失 |
| **文档** | 更新相关文档 | 不更新文档 | 文档过时 |
| **安全/供应链** | 不触及安全边界、不新增依赖 | 绕过鉴权/关闭校验/新增依赖 | 安全风险 |

### 5.2 深度路径

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **适用范围** | 跨文件/新功能/重构/API变更 | 简单配置修改 | 过度设计 |
| **完整流程** | Analyst → Prometheus ↔ Skeptic → Oracle → Worker | 跳过任何阶段 | 质量风险 |
| **停止点** | 在每个停止点等待确认 | 绕过停止点 | 决策失误 |

### 5.3 TDD深度路径

| 约束项 | 白名单（✅ 允许） | 黑名单（❌ 禁止） | 违反后果 |
|--------|------------------|------------------|----------|
| **适用范围** | 核心业务/复杂逻辑/高覆盖要求 | 简单工具函数 | 过度测试 |
| **测试独立** | Tester基于设计生成CSV | Tester查看代码 | 失去独立性 |
| **权限隔离** | Tester-CSV, TestWorker-测试代码 | 角色权限混淆 | 测试质量下降 |
| **人工审核** | CSV测试用例人工审核 | 自动通过 | 测试质量风险 |

---

## 6. 违反后果等级

### 6.1 轻微违规（警告）

| 违规类型 | 后果 | 处理方式 |
|----------|------|----------|
| 文档格式不规范 | 可读性下降 | Librarian提醒修正 |
| 链接未及时更新 | 导航困难 | 自动检查+提醒 |
| 版本号未更新 | 版本混乱 | 自动提醒更新 |

### 6.2 中度违规（阻止）

| 违规类型 | 后果 | 处理方式 |
|----------|------|----------|
| 跳过停止点 | 决策失误风险 | 强制停止，回退到停止点 |
| 未标记状态 | 状态混乱 | 要求补标记 |
| 权限越界（只读） | 数据完整性风险 | 阻止操作，记录日志 |

### 6.3 严重违规（熔断）

| 违规类型 | 后果 | 处理方式 |
|----------|------|----------|
| 修改SOP标准 | 流程被破坏 | 立即熔断，人工介入 |
| 破坏测试独立性 | 测试失效 | 立即熔断，重新设计 |
| 连续3次失败 | 方向错误 | 触发三错即停，Supervisor介入 |
| 严重权限越界 | 安全风险 | 立即熔断，审计调查 |

---

## 7. 快速参考

### 7.1 角色权限速查

| 角色 | 可写 | 只读 | 禁止 |
|------|------|------|------|
| Router | 状态 | 全局 | 代码/文档 |
| Explorer | 无 | 代码/文档 | 任何修改 |
| Analyst | PRD/MRD/FRD/原型 | 背景 | 代码/架构 |
| Prometheus | 架构文档 | 需求 | 实现细节 |
| Skeptic | 审查意见 | 架构 | 修改架构 |
| Oracle | design.md | 架构 | 代码实现 |
| Tester | CSV | 设计 | 代码/测试代码 |
| TestWorker | 测试代码 | CSV/代码接口 | CSV/功能代码 |
| Worker | 功能代码 | 设计/测试 | 设计文档 |
| Supervisor | 状态/报告 | 全局 | 代码/文档 |
| Librarian | 索引/SOP | 文档 | 文档内容 |

### 7.2 阶段禁止速查

| 阶段 | 核心禁止 |
|------|----------|
| 需求 | 禁止编码，禁止不与用户确认 |
| 架构 | 禁止技术绑定，禁止超过3轮审查 |
| 实现设计 | 禁止直接编码，禁止不做技术对比 |
| 测试用例 | 禁止参考代码，禁止非Tester修改CSV |
| 编码 | 禁止偏离设计，禁止跳过测试 |

### 7.3 文件禁止速查

| 文件 | 唯一维护者 | 禁止操作 |
|------|-----------|----------|
| CSV测试用例 | Tester | 非Tester修改 |
| 测试代码 | TestWorker | 非TestWorker修改 |
| SOP标准 | Librarian | 非Librarian修改 |
| 架构文档 | Prometheus | 非Prometheus修改 |

---

## 8. 相关文档

- [角色矩阵](../02_role_matrix/index.md) - 完整角色权限定义
- [工作流规范](../03_workflow/index.md) - 路径选择和流程规范
- [快速参考](../ROLE_CHEATSHEET.md) - 角色和流程速查

---

**注意**: 本文档定义SOP流程中的禁止项。所有角色必须遵守，违反将触发相应的处理机制。
