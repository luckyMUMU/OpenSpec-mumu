# Spec 设计阶段交互式提问机制规范

## Why

当前 Spec 模式在规范设计阶段存在以下问题：
1. **单向输出**：Agent 直接输出 spec.md/tasks.md/checklist.md，缺少与用户的交互确认
2. **冲突未发现**：设计中存在的冲突（如与现有 ADR 矛盾、设计决策冲突）未主动识别
3. **决策未记录**：用户决策未及时更新到 ADR 等持久化文档
4. **视角单一**：未从多角度（性能、安全、可维护性等）审视设计

## What Changes

### 1. 新增 Spec 设计阶段提问流程
- 在 spec.md 编写过程中引入循环提问机制
- 从多角度（架构、性能、安全、可维护性、兼容性）审视设计
- 主动发现与现有 ADR/设计文档的冲突

### 2. 新增冲突检测机制
- 检测新设计是否与现有 ADR 矛盾
- 检测设计决策是否与现有架构设计冲突
- 检测技术选型是否与约束矩阵冲突

### 3. 新增决策记录更新机制
- 用户决策后自动更新或创建 ADR
- 更新相关设计文档的决策记录章节
- 确保决策可追溯

## Impact

- Affected specs: 
  - Spec 模式执行流程
  - ADR 模板
  - 设计决策规则
- Affected code: 无代码变更，仅流程规范更新

## ADDED Requirements

### Requirement: Spec 设计阶段交互式提问

系统 SHALL 在 Spec 设计阶段提供交互式提问机制。

#### Scenario: 多角度审视
- **WHEN** Agent 编写 spec.md 时
- **THEN** 系统应从以下角度审视设计：
  - 架构一致性：是否与现有架构设计一致
  - ADR 合规性：是否与现有 ADR 冲突
  - 性能影响：是否引入性能问题
  - 安全风险：是否引入安全风险
  - 可维护性：是否增加维护成本
  - 兼容性：是否影响现有功能

#### Scenario: 冲突发现
- **WHEN** 发现设计冲突时
- **THEN** 系统应主动向用户提问，提供选项并记录决策

#### Scenario: 决策记录
- **WHEN** 用户做出决策后
- **THEN** 系统应更新或创建相应的 ADR 文档

### Requirement: 冲突检测机制

系统 SHALL 提供设计冲突全量自动检测机制。

#### Scenario: 全量检测范围
- **WHEN** 开始编写 spec.md 时
- **THEN** 系统应检测以下所有文档：
  - 所有 ADR 文档（`docs/04_context_reference/adr_*.md`）
  - 所有设计文档（`**/design.md`）
  - 约束矩阵（`sop/05_constraints/constraint_matrix.md`）
  - 架构设计文档（`docs/02_logical_workflow/*.md`）

#### Scenario: ADR 冲突检测
- **WHEN** 新设计与现有 ADR 存在矛盾
- **THEN** 系统应提示冲突内容并询问用户决策

#### Scenario: 设计文档冲突检测
- **WHEN** 新设计与现有 design.md 或架构文档存在矛盾
- **THEN** 系统应提示冲突内容并询问用户决策

#### Scenario: 约束矩阵冲突检测
- **WHEN** 新设计违反约束矩阵中的约束
- **THEN** 系统应提示违规内容并询问用户决策

### Requirement: 提问格式规范

系统 SHALL 使用结构化选项格式进行提问。

#### Scenario: 结构化选项提问
- **WHEN** 需要向用户提问时
- **THEN** 系统应使用 AskUserQuestion 工具，提供 2-4 个选项供用户选择

#### Scenario: 选项设计原则
- **WHEN** 设计提问选项时
- **THEN** 系统应遵循以下原则：
  - 每个选项应有明确的含义和影响说明
  - 推荐选项应标注"(推荐)"
  - 选项应覆盖主要处理路径

### Requirement: 决策分级记录

系统 SHALL 分级记录用户决策。

#### Scenario: 重要决策记录
- **WHEN** 用户决策涉及以下内容时
- **THEN** 系统应创建或更新 ADR：
  - 架构变更
  - 技术选型
  - 安全策略
  - 性能策略
  - 与现有 ADR 冲突的决策

#### Scenario: 一般决策记录
- **WHEN** 用户决策不涉及重要架构变更时
- **THEN** 系统应在 spec.md 中增加 `## 决策记录` 章节记录

#### Scenario: 决策记录格式
- **WHEN** 记录决策时
- **THEN** 系统应使用以下格式：

```markdown
## 决策记录

| 决策ID | 冲突类型 | 决策内容 | 影响范围 | 记录位置 |
|--------|----------|----------|----------|----------|
| D001 | ADR冲突 | 选择方案A | 全局 | ADR-XXX |
| D002 | 设计冲突 | 修改设计 | 模块 | spec.md |
```

### Requirement: 决策记录更新

系统 SHALL 在用户决策后更新相关文档。

#### Scenario: 创建新 ADR
- **WHEN** 用户做出重要设计决策且无现有 ADR 覆盖
- **THEN** 系统应创建新的 ADR 记录决策

#### Scenario: 更新现有 ADR
- **WHEN** 用户决策修改了现有 ADR 的内容
- **THEN** 系统应更新现有 ADR 并记录变更历史

#### Scenario: 更新设计文档
- **WHEN** 用户决策影响现有设计文档
- **THEN** 系统应更新相关设计文档的决策记录章节

## MODIFIED Requirements

### Requirement: Spec 模式执行流程

Spec 模式执行流程 SHALL 包含实时交互式提问阶段：

**原流程**：
1. 编写 spec.md
2. 编写 tasks.md
3. 编写 checklist.md
4. 通知用户确认

**新流程**：
1. 开始编写 spec.md
2. **实时检测冲突**（编写过程中持续检测）
3. **发现冲突即时提问**（按影响范围优先级排序）
4. **用户决策后展示 ADR 更新内容**
5. **用户确认后更新 ADR/设计文档**
6. 继续编写 spec.md（循环 2-5 直到完成）
7. **可选：从关键角度进行确认性提问**（混合模式）
8. 完善并定稿 spec.md
9. 编写 tasks.md
10. 编写 checklist.md
11. 通知用户确认

### Requirement: 提问触发机制

系统 SHALL 实现实时检测即时提问机制。

#### Scenario: 实时冲突检测
- **WHEN** Agent 编写 spec.md 过程中
- **THEN** 系统应在每个章节编写完成后进行全量检测：
  - ADR 冲突（最高优先级）
  - 约束矩阵冲突
  - 设计文档冲突
  - 性能/安全风险

#### Scenario: 即时提问
- **WHEN** 检测到冲突时
- **THEN** 系统应立即暂停编写，向用户提问并提供选项

#### Scenario: 混合模式提问
- **WHEN** spec.md 编写完成且无检测到的问题
- **THEN** 系统应从关键角度进行确认性提问：
  - 架构一致性确认
  - 安全风险确认
  - 性能影响确认

#### Scenario: 章节级无冲突处理
- **WHEN** 某章节检测完成且无冲突
- **THEN** 系统应静默继续编写下一章节

### Requirement: 冲突优先级处理

系统 SHALL 按影响范围优先级处理冲突。

#### Scenario: 优先级排序
- **WHEN** 存在多个冲突时
- **THEN** 系统应按以下顺序处理：
  1. 影响全局架构的冲突
  2. 影响多个模块的冲突
  3. 影响单个模块的冲突
  4. 影响单个文件的冲突

### Requirement: ADR 确认更新机制

系统 SHALL 在用户确认后更新 ADR。

#### Scenario: 展示更新内容
- **WHEN** 用户做出决策后
- **THEN** 系统应展示 ADR 更新内容预览

#### Scenario: 用户确认更新
- **WHEN** 用户确认 ADR 更新内容
- **THEN** 系统应更新或创建相应的 ADR 文档

#### Scenario: 用户拒绝更新
- **WHEN** 用户拒绝 ADR 更新内容
- **THEN** 系统应记录用户决策但不更新 ADR，继续后续流程

#### Scenario: 拒绝决策记录格式
- **WHEN** 用户拒绝 ADR 更新时
- **THEN** 系统应在 spec.md 的决策记录章节标注：

```markdown
| D003 | ADR冲突 | 用户选择不更新ADR，保留现有设计 | 模块 | spec.md (拒绝更新) |
```

## REMOVED Requirements

无移除的需求。

## 与现有约束的关系

### 与约束矩阵的一致性

本规范与 `sop/05_constraints/constraint_matrix.md` 中的以下约束保持一致：

| 约束项 | 本规范对应章节 | 说明 |
|--------|----------------|------|
| 无出处决策 | 提问触发机制 | 无依据判断须 `ASK_USER_DECISION` |
| 审查确认 | ADR 确认更新机制 | 审查结论须通过明确提问确认 |
| 审查循环 | 冲突优先级处理 | 遵循最多3轮审查约束 |
| 来源与依赖 | 决策分级记录 | 产物声明来源与依赖 |

### 与 ADR 模板的关系

本规范扩展了 `sop/04_reference/document_templates/adr.md` 模板，新增：
- 决策变更记录章节
- 与 Spec 的关联字段

### 与设计决策规则的关系

本规范遵循 `sop/04_reference/design_decision_rules.md` 中的冲突处理规则：
- 优先级规则：快速路径 > 目录层级 > 代码复杂度
- 目录边界：不跨越 design.md 边界

## 提问角度清单

### 1. 架构一致性
- [ ] 是否与现有 L2 架构设计一致？
- [ ] 是否需要修改现有架构设计？
- [ ] 是否引入新的架构模式？

### 2. ADR 合规性
- [ ] 是否与现有 ADR 冲突？
- [ ] 是否需要创建新 ADR？
- [ ] 是否需要废弃现有 ADR？

### 3. 性能影响
- [ ] 是否引入性能瓶颈？
- [ ] 是否需要性能优化策略？
- [ ] 是否影响现有性能指标？

### 4. 安全风险
- [ ] 是否引入安全漏洞？
- [ ] 是否需要安全审查？
- [ ] 是否影响现有安全机制？

### 5. 可维护性
- [ ] 是否增加代码复杂度？
- [ ] 是否需要重构现有代码？
- [ ] 是否引入技术债务？

### 6. 兼容性
- [ ] 是否影响现有 API 兼容性？
- [ ] 是否需要数据迁移？
- [ ] 是否影响现有配置？

## 冲突处理流程

```
发现冲突
    │
    ▼
记录冲突内容 ──► 冲突类型（ADR/设计/约束）
    │
    ▼
生成提问 ──► 提供选项（遵循现有/修改现有/创建新规则）
    │
    ▼
用户决策
    │
    ├─── 遵循现有 ──► 调整设计
    │
    ├─── 修改现有 ──► 更新 ADR/设计文档
    │
    └─── 创建新规则 ──► 创建新 ADR
    │
    ▼
继续审视（循环直到无冲突）
```

## ADR 更新模板

当用户决策需要更新 ADR 时，使用以下格式：

```markdown
## 决策变更记录

| 日期 | 变更类型 | 原决策 | 新决策 | 触发任务 |
|------|----------|--------|--------|----------|
| YYYY-MM-DD | 修改/新增/废弃 | [原内容] | [新内容] | [change-id] |
```
