# SOP 文档编写指南

> **文档定位**: 指导 SOP 文档的编写和维护  
> **使用对象**: 维护 SOP 文档的开发者 / AI Agent  
> **版本**: v1.0  
> **最后更新**: 2026-02-07

---

## 1. 核心原则

### 1.1 渐进式披露 (Progressive Disclosure)

信息按重要性分层展示，仅在需要时展示更多细节：

```
L1: 概念层 (01_concept_overview.md)
   └── 是什么、为什么
   └── 只保留概念说明和链接

L2: 角色层 (02_role_matrix/)
   └── 谁来做、做什么
   └── 角色定义、权限、职责

L3: 流程层 (03_workflow/)
   └── 怎么做、何时做
   └── 工作流程、规则、停止点

L4: 参考层 (04_reference/)
   └── 具体模板、示例
   └── 文档模板、技术规范
```

**约束**: 父级文档只保留摘要+链接，严禁展开细节。

---

### 1.2 单一来源 (Single Source of Truth)

每个概念只在最权威的文档中详细定义：

| 概念 | 权威来源 | 其他文档处理方式 |
|------|----------|------------------|
| 角色定义 | `02_role_matrix/index.md` | 只保留表格摘要+链接 |
| 工作流 | `03_workflow/index.md` | 只保留流程摘要+链接 |
| 三错即停 | `03_workflow/three_strike_rule.md` | 只保留简要说明+链接 |
| 文档模板 | `04_reference/index.md` | 只保留类型说明+链接 |

**禁止**: 在多个文档中重复定义同一概念。

---

### 1.3 信息密度 (Information Density)

优先使用结构化格式，减少描述性文字：

| 推荐 | 不推荐 |
|------|--------|
| 表格 | 大段文字描述 |
| 列表 | 冗长段落 |
| 代码块 | 复杂流程的文字说明 |
| 图表 | 抽象概念的文字解释 |

**目标**: 提高 Token 效率，便于 AI Agent 快速理解。

---

## 2. 文档结构规范

### 2.1 文件组织

```
sop/
├── AGENT_SOP.md              # 入口文档：导航+摘要
├── AGENT_SOP_COMPACT.md      # 紧凑版：AI Agent核心指令
├── ROLE_CHEATSHEET.md        # 角色速查卡：快速参考
├── sop_GUIDE.md              # 本文件：编写指南
├── 01_concept_overview.md    # L1: 核心概念与价值
├── 02_role_matrix/           # L2: 角色定义与职责
│   ├── index.md              # 角色矩阵总览（权威）
│   └── [role].md             # 各角色详细定义
├── 03_workflow/              # L3: 工作流详细规范
│   ├── index.md              # 工作流总览（权威）
│   ├── fast_path.md          # 快速路径详情
│   ├── deep_path.md          # 深度路径详情
│   └── three_strike_rule.md  # 三错即停规则（权威）
├── 04_reference/             # L4: 参考文档与模板
│   ├── index.md              # 参考文档首页（权威）
│   ├── document_templates/   # 文档模板
│   └── interaction_formats/  # 交互格式
├── prompts/                  # AI Agent提示词
│   └── [role]_prompt.md      # 各角色提示词
└── skills/                   # AI Agent Skill定义
    └── [skill-name]/         # Skill目录
        └── SKILL.md          # Skill定义文件
```

---

### 2.3 Skill 和智能体定义规范

#### 2.3.1 Skill 定义

**用途**: Skill 是 AI Agent 的功能模块定义，描述特定任务的完整执行逻辑。

**文件格式**: `SKILL.md`

```markdown
---
name: "skill-name"
description: "功能描述。Invoke when 触发条件。"
---

# Skill 标题

## 使用场景
- 场景1
- 场景2

## 工作流程
### Step 1: ...
### Step 2: ...

## 输入格式
...

## 输出格式
...
```

**存放位置**: `sop/skills/[skill-name]/SKILL.md`

**与角色的关系**: 
- Skill 封装了角色的核心能力
- 一个角色可以有多个 Skill
- Skill 可以被多个角色复用

---

#### 2.3.2 智能体 Prompt 定义

**用途**: Prompt 是直接给 AI Agent 的指令模板，用于激活特定角色。

**文件格式**: `[role]_prompt.md`

```markdown
# [Role] Prompt

你现在是 **[Role]** 角色，负责[职责]。

## 你的职责
1. 职责1
2. 职责2

## 工作流程
...

## 约束
...

## 当前任务
[任务描述]

请开始执行。
```

**存放位置**: `sop/prompts/[role]_prompt.md`

**与角色的关系**:
- Prompt 是角色的"激活指令"
- 每个主要角色对应一个 Prompt
- Prompt 包含角色身份、职责、约束

---

#### 2.3.3 Skill vs Prompt 对比

| 特性 | Skill | Prompt |
|------|-------|--------|
| **用途** | 功能模块定义 | 角色激活指令 |
| **格式** | SKILL.md (带 frontmatter) | Markdown |
| **内容** | 完整工作流程、输入输出规范 | 角色身份、职责、约束 |
| **使用场景** | 被 AI 系统调用 | 直接发送给 AI Agent |
| **存放位置** | `skills/[name]/` | `prompts/` |
| **目标读者** | AI 系统 / 开发者 | AI Agent |

---

#### 2.3.4 编写规范

**Skill 编写规范**:
- [ ] 必须包含 frontmatter (name, description)
- [ ] description 必须包含 "Invoke when" 触发条件
- [ ] 必须定义使用场景
- [ ] 必须定义输入/输出格式
- [ ] 工作流程必须分步骤

**Prompt 编写规范**:
- [ ] 标题格式: `[Role] Prompt`
- [ ] 必须以 "你现在是 **[Role]** 角色" 开头
- [ ] 必须包含职责、工作流程、约束
- [ ] 必须包含 "当前任务" 占位符
- [ ] 语言简洁，指令清晰

**命名规范**:
- Skill: `sop-[function]-[action]` (如 `sop-workflow-orchestrator`)
- Prompt: `[role]_prompt` (如 `router_prompt`)

---

### 2.2 层级规范

#### L1 概念层 (`01_concept_overview.md`)

**内容**: 
- 一句话定义
- 核心原则
- 解决的痛点
- 快速导航（链接到L2-L4）

**约束**:
- [ ] 只保留概念说明
- [ ] 使用链接引用详细内容
- [ ] 禁止展开角色/流程细节

---

#### L2 角色层 (`02_role_matrix/`)

**内容**:
- 角色总览表格
- 权限矩阵
- 角色分类（规划/需求/设计/实现/监管）
- 链接到各角色详细定义

**约束**:
- [ ] 角色表格是权威定义
- [ ] 禁止重复描述工作流
- [ ] 使用链接引用流程层

---

#### L3 流程层 (`03_workflow/`)

**内容**:
- 工作流总览
- 路径选择规则
- 停止点定义
- 质量控制规则

**约束**:
- [ ] 流程图和表格优先
- [ ] 详细规则单独成文
- [ ] 使用链接引用详细规则

---

#### L4 参考层 (`04_reference/`)

**内容**:
- 文档模板
- 交互格式
- 技术规范
- 示例代码

**约束**:
- [ ] 提供可直接使用的模板
- [ ] 格式统一、完整
- [ ] 链接到使用场景

---

## 3. 编写规范

### 3.1 格式规范

#### 标题层级
```markdown
# 文档标题（H1，唯一）

## 主要章节（H2）

### 子章节（H3）

#### 细节说明（H4，尽量少用）
```

#### 表格规范
- 使用对齐标记提高可读性
- 表头使用粗体
- 单元格内容简洁

```markdown
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 内容 | 内容 | 内容 |
```

#### 代码块规范
- 标明语言类型
- 用于流程、配置、示例
- 避免过长代码块

```markdown
```python
# 示例代码
```
```

---

### 3.2 链接规范

#### 内部链接
- 使用相对路径
- 链接文本清晰描述目标

```markdown
👉 [查看角色矩阵](./02_role_matrix/index.md)
👉 [前往工作流规范](../03_workflow/index.md)
```

#### 锚点链接
- 用于长文档内导航
- 锚点名称使用小写+连字符

```markdown
[跳转到角色定义](#角色定义)
```

---

### 3.3 标记规范

#### 状态标记
```markdown
- `[进行中]` / `[已完成]`
- `[WAITING_FOR_REQUIREMENTS]`
- `[WAITING_FOR_ARCHITECTURE]`
- `[WAITING_FOR_DESIGN]`
- `[ARCHITECTURE_PASSED]`
- `[USER_DECISION]`
```

#### 优先级标记
```markdown
- 🔴 严重（必须解决）
- 🟡 一般（建议解决）
- 🟢 建议（可选采纳）
```

---

## 4. 维护指南

### 4.1 更新流程

1. **识别权威来源**
   - 确定概念属于哪个层级
   - 找到权威文档位置

2. **修改权威文档**
   - 在权威文档中更新内容
   - 确保格式符合规范

3. **更新相关链接**
   - 检查引用该概念的其他文档
   - 更新摘要和链接（如需要）

4. **验证一致性**
   - 检查是否存在重复内容
   - 验证链接有效性

---

### 4.2 审核清单

#### 内容审核
- [ ] 是否符合渐进式披露原则
- [ ] 是否存在与其他文档的重复内容
- [ ] 概念是否只在权威文档中详细定义
- [ ] 信息密度是否足够高（表格>段落）

#### 格式审核
- [ ] 标题层级是否正确
- [ ] 表格格式是否规范
- [ ] 代码块是否标明语言
- [ ] 链接是否使用相对路径

#### 链接审核
- [ ] 所有链接是否有效
- [ ] 链接文本是否清晰
- [ ] 是否链接到权威来源

#### Skill/Prompt 审核
- [ ] Skill 是否包含 frontmatter (name, description)
- [ ] Skill description 是否包含 "Invoke when"
- [ ] Prompt 是否以 "你现在是 **[Role]** 角色" 开头
- [ ] Prompt 是否包含 "当前任务" 占位符
- [ ] Skill/Prompt 是否与角色对应

---

## 5. 示例

### 5.1 正确的L1文档写法

```markdown
# AI 项目通用规约

**一句话定义**：...

## 核心概念

### 角色分工
九个专业角色，各司其职：

👉 [查看完整角色矩阵](./02_role_matrix/index.md)

### 三错即停
质量控制机制：...

👉 [查看三错即停详情](./03_workflow/three_strike_rule.md)
```

**优点**: 只保留概念和链接，符合渐进披露。

---

### 5.2 错误的L1文档写法

```markdown
# AI 项目通用规约

## 角色分工

| 角色 | 职责 | 输入 | 输出 | 下一步 |
|------|------|------|------|--------|
| Router | ... | ... | ... | ... |
| ... | ... | ... | ... | ... |

## 工作流程

### 深度路径
Analyst → Prometheus ↔ Skeptic → Oracle → Worker → Librarian
...
```

**问题**: L1文档包含了L2和L3的详细内容，违反渐进披露。

---

## 6. 版本管理

### 6.1 版本号规则

- **主版本**: 重大结构变更（如新增角色层级）
- **次版本**: 内容更新（如新增角色、流程调整）
- **修订号**: 修正错误、优化格式

### 6.2 变更记录

在每个文档底部记录：

```markdown
---

## 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.1 | 2026-02-07 | 优化角色描述 | @author |
| v1.0 | 2026-02-01 | 初始版本 | @author |
```

---

## 7. 快速参考

### 7.1 文档类型速查

| 文档类型 | 用途 | 目标读者 |
|----------|------|----------|
| `AGENT_SOP.md` | 入口导航 | 所有用户 |
| `AGENT_SOP_COMPACT.md` | AI Agent核心指令 | AI Agent |
| `ROLE_CHEATSHEET.md` | 角色速查 | AI Agent |
| `01_concept_overview.md` | 核心概念 | 新用户 |
| `02_role_matrix/index.md` | 角色定义 | 开发者 |
| `03_workflow/index.md` | 工作流程 | 开发者 |
| `04_reference/index.md` | 模板规范 | 开发者 |
| `prompts/[role]_prompt.md` | 角色激活指令 | AI Agent |
| `skills/[name]/SKILL.md` | 功能模块定义 | AI 系统/开发者 |

### 7.2 常见问题

**Q: 新角色应该放在哪里？**  
A: 在 `02_role_matrix/` 下创建 `[role].md`，并在 `index.md` 中添加链接。同时创建对应的 `prompts/[role]_prompt.md`。

**Q: Skill 和 Prompt 有什么区别？**  
A: Skill 是功能模块定义（带 frontmatter），Prompt 是角色激活指令。Skill 面向 AI 系统，Prompt 面向 AI Agent。

**Q: 如何修改已有概念？**  
A: 找到权威文档，修改后检查引用该概念的其他文档是否需要更新链接。

**Q: 可以复制内容到多个文档吗？**  
A: 不可以。使用链接引用，保持单一来源。

---

**维护者**: OpenSpec Team  
**反馈**: 请在文档仓库提交 Issue
