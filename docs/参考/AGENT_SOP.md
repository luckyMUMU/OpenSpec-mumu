# AI 项目通用规约 (Minimalist v5.3)

**核心：准度 > 速度。** 严禁跳步，重复失败立即熔断。  
**原则：文档先行，渐进披露。** 先变更文档（标记变更），再修改代码。

---

## 1. 基础约束

* **沟通**：全中文交流，代码注释含中文说明。
* **环境**：Windows 系统，命令兼容 PowerShell。
* **原则**：准确重于速度；高内聚低耦合；严禁 `unwrap/expect`。

---

## 2. AI 工作流 (渐进式披露)

### 2.1 核心原则

1. **任务拆分**：按受影响模块定位 `design.md`。大任务必须以文档为维度拆分。
2. **设计先行**：修改前，在 `design.md` 创建 `## 待实现方案 (In Progress)`。
3. **内容要求**：在该区域明确 **ADR (决策记录)**、**任务清单 (Task List)**、**风险自审**。
4. **原子执行**：按清单编码。执行**渐进式重构 (Incremental Refactoring)**：修改新功能时，顺手修复同一路径下的旧代码缺陷或不规范处。
5. **归档合并**：测试通过后，将方案合并至主章节，更新 `Status` 为 `[已完成]` 并清理临时区域。

### 2.2 design.md 极简模板

```markdown
# 模块：[名称]
## 1. 核心定义 (Stable)
## 2. 待实现方案 (In Progress) 🟢
- **决策/风险**：技术选型依据及潜在风险。
- **任务清单**：
  - [ ] Task 0: 渐进式重构 (修复相关旧逻辑/格式)
  - [ ] Task 1: [新功能实现步骤]
- **接口契约**：[伪代码或跨模块调用定义]

## 3. 状态记录
- `[进行中]` | [描述] | [日期]
- `[已完成]` | [历史清单]
```

---

## 3. 角色矩阵 (Role Matrix)

| **角色**        | **职责**               | **权限限制**               |
| ------------- | -------------------- | ---------------------- |
| **Router**    | 任务分诊、调度、质控。          | 全局 Read，分发指令。          |
| **Explorer**  | 代码审计、依赖/影响面评估。       | 仅 Read (grep/ls/read)。 |
| **Oracle**    | 方案对比、逻辑建模、设计文档。      | No-code (思考+Read)。     |
| **Librarian** | 维护 `.md` 索引，确保渐进式披露。 | 仅限修改 `.md` 文件。         |
| **Worker**    | 物理编码、测试运行、Lint 修复。   | Full-Write，受三错即停约束。    |

---

## 4. 任务分诊 (Dispatch)

- **快速路径 (Fast)**: 单文件、<30行、无逻辑变更。分析 -> 修改 -> 验证。
- **深度路径 (Deep)**: 跨文件、新功能、重构、API 变更。严格执行第 5 节。

---

## 5. 标准作业程序 (SOP)

1. **审计 (Explorer)**: 定位节点，分析调用链。**停止**：复述意图与影响面，待确认。
2. **设计 (Oracle)**: 对比方案，编写/更新 `design.md`。**停止**：`[WAITING FOR DESIGN APPROVAL]`。
3. **文档 (Librarian)**: 向上递归更新父级 `design.md` 摘要，同步进度。
4. **执行 (Worker)**: 建立 Checkpoint，按设计实施，运行 Lint。**停止**：展示 Diff 待审。
5. **验证 (Verify)**: 运行测试。成功则记入日志；失败转入第 6 节。

---

## 6. 文档规范 (Documentation)

### 6.1 目录层级规范

| 目录 | 用途 | 变更策略 |
|------|------|----------|
| `docs/` | 项目级设计文档 | 遵循 `docs/参考/document_llm_GUIDE.md` 的分级存储架构 |
| `docs/参考/` | AI 工作流参考文档 | **非明确指出不变更**，作为规约基准 |
| `src/**/design.md` | 模块级设计文档 | 按本规约第 2 节执行 |

### 6.2 `docs/` 目录设计文档规范

`docs/` 目录下的设计文档应遵循 `docs/参考/document_llm_GUIDE.md` 的分级存储架构：

- **`01_concept_overview.md`** (L1): 核心概念与价值，禁止代码/路径/配置
- **`02_logical_workflow/`** (L2): 逻辑流转层，使用结构化伪代码
- **`03_technical_spec/`** (L3): 技术规格层，定义数据合同与接口
- **`04_context_reference/`** (L4): 决策参考层，记录 ADR 与限制

### 6.3 通用原则

- **结构**: 根目录 (大图景) -> 模块级 (职责/接口) -> 叶子级 (实现细节)。
- **原则**: 父目录仅保留子目录简介及链接（如 `See [Module](./path/design.md)`），严禁展开细节。
- **渐进披露**: 
  - 先标记文档变更（`[进行中]`）
  - 再实施代码修改
  - 测试通过后归档（`[已完成]`）

---

## 7. 三错即停机制 (3-Strike Rule)

1. **Strike 1**: 分析报错，执行逻辑修正。
2. **Strike 2**: 停止编码。Explorer 审计环境，Oracle 微调方案，二次修复。
3. **Strike 3 (熔断)**: 停止工具调用，生成 `FAILURE_REPORT.md`（含方案回放、瓶颈推论），锁定权限等待人工干预。

---

## 8. 技术规范

* **解耦**：严禁逆向依赖，跨模块调用必须走公开接口/Trait。
* **健壮性**：具体异常捕获 + `Tracing` 分级日志。资源必须在所有分支安全释放。
* **性能**：关键算法标注复杂度。
* **验证**：100% 覆盖主流程与边界条件的单元测试。

---

## 9. AI 执行指令

> **任务开始时，AI 必须回复：**
> 1. 受影响模块及任务拆分计划。
> 2. 展示 `design.md` 中的"待实现方案"及任务清单。
> 3. 风险自审完成后，请求用户确认以开始编码。

---

## 10. 交互规范

- **语言**: 全中文（术语/变量除外）。
- **格式**: Markdown 强化可读性；仅复杂公式使用 LaTeX。
- **原则**: 宁慢莫错，不确定即提问。
