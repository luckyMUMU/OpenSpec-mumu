# AI 项目协作规约 - 人类阅读版

> **版本**: v5.6  
> **更新日期**: 2026-02-07  
> **适用对象**: 产品经理、项目经理、技术负责人、开发者

---

## 1. 什么是这套规约？

这是一套**人与 AI 协作开发**的标准工作流程。它定义了：

- **什么时候**让 AI 参与开发
- **让哪个 AI 角色**做哪部分工作
- **如何检查** AI 的工作质量
- **出了问题怎么办**

### 1.1 核心原则

| 原则 | 含义 | 为什么重要 |
|------|------|-----------|
| **准度 > 速度** | 宁可慢，也要对 | AI 犯错成本高，返工更费时 |
| **文档先行** | 先写设计文档，再写代码 | 确保理解一致，减少返工 |
| **渐进披露** | 按需获取信息，避免信息过载 | 提高决策效率 |

### 1.2 解决什么问题？

- ✅ AI 理解偏差导致代码不符合预期
- ✅ 复杂任务拆分不清，进度难以追踪
- ✅ 代码写完了，文档没更新
- ✅ AI 连续犯错，浪费大量时间

---

## 2. AI 角色分工（9个角色）

把 AI 看作一个**虚拟团队**，每个角色有明确分工：

### 2.1 规划层（做决策）

| 角色 | 职责 | 权限 | 人类对应角色 |
|------|------|------|-------------|
| **Router** | 任务分诊、调度、质控 | 全局读取，分发指令 | 项目经理 |
| **Explorer** | 代码审计、依赖/影响面评估 | 仅读取（搜索/读取/分析） | 技术负责人 |

**Router 做什么**：
- 分析任务复杂度
- 选择处理路径（快速/深度）
- 分配 AI 角色

**Explorer 做什么**：
- 分析代码结构
- 评估影响范围
- 识别潜在风险

---

### 2.2 需求层（挖需求）

| 角色 | 职责 | 权限 | 产出物 |
|------|------|------|--------|
| **Analyst** | 需求挖掘、PRD 生成、多维度分析 | 读取背景，写入需求文档 | PRD 需求文档 |

**Analyst 做什么**：
- 通过多轮对话澄清需求
- 从业务、用户、技术、风险等多维度分析需求
- 生成结构化的 PRD 文档
- 确保需求理解准确

---

### 2.3 设计层（出方案）

| 角色 | 职责 | 权限 | 产出物 |
|------|------|------|--------|
| **Prometheus** | 架构设计、伪代码编写、接口规范 | 架构文档读写 | 架构设计文档 |
| **Skeptic** | 审查架构设计，发现问题和风险 | 读取架构，写入审查意见 | 审查报告 |
| **Oracle** | 实现设计、方案对比、逻辑建模 | 实现文档读写 | 实现设计文档 |

**区别**：
- **Analyst** = 需求分析师（了解用户想要什么）
- **Prometheus** = 建筑师（画蓝图，不考虑具体材料）
- **Skeptic** = 审查员（挑刺找问题，确保质量）
- **Oracle** = 工程师（根据蓝图做施工方案）

**Prometheus 与 Skeptic 的协作**：
- Prometheus 设计架构 → Skeptic 审查提出问题 → Prometheus 回复修改
- 循环最多 3 轮，直到设计完善

---

### 2.4 实现层（写代码）

| 角色 | 职责 | 权限 | 注意 |
|------|------|------|------|
| **Worker** | 物理编码、测试运行、质量检查 | 代码读写（受三错即停约束） | 只能按设计写，不能改设计 |

**Worker 做什么**：
- 严格按照设计文档编写代码
- 运行测试确保质量
- 进行代码质量检查

**Worker 的约束**：
- 不能修改设计文档
- 受三错即停机制约束
- 必须展示 Diff 等待审批

---

### 2.5 监管层（控质量）

| 角色 | 职责 | 权限 | 触发时机 |
|------|------|------|----------|
| **Supervisor** | 进度监管、熔断决策、用户协调 | 状态更新 + 决策触发 | Worker 连续出错 3 次 |
| **Librarian** | 维护文档索引，确保渐进式披露 | 文档文件读写 | 每个阶段完成后 |

**Supervisor 做什么**：
- 监控任务进度
- 检测异常情况
- 触发熔断机制
- 生成失败报告

**Librarian 做什么**：
- 更新文档索引
- 维护链接有效性
- 确保渐进披露结构
- 标记文档状态

---

### 2.6 角色关系图

```
Router(入口)
  ├─ 快速路径 → Explorer → Worker → Librarian
  └─ 深度路径 → Analyst → Prometheus ↔ Skeptic → Oracle → Worker → Librarian
                                              ↓
                                         Supervisor(全局监管)
```

---

## 3. 两种工作模式

### 3.1 快速模式（简单任务）

**适用场景**：
- 单文件修改
- 小范围变更（<30行）
- 无逻辑变更（配置、文档、格式）
- 文档更新
- 配置调整

**处理流程**：
```
Explorer 分析 → Worker 修改 → Librarian 更新文档
```

**预计时间**：5-30 分钟

---

### 3.2 深度模式（复杂任务）

**适用场景**：
- 跨文件变更
- 新功能开发
- 代码重构
- API 变更
- 系统架构调整

**处理流程**：
```
新项目/大重构：
Analyst → Prometheus ↔ Skeptic → Oracle → Worker → Librarian

功能迭代：
Analyst → Oracle → Worker → Librarian
```

**说明**：
- **Analyst** 首先与用户对话，挖掘需求，生成 PRD 文档
- **Prometheus ↔ Skeptic** 是多轮审查循环，直到设计完善
- 需求确认后才进入设计和编码阶段

**预计时间**：1 天到 2 周不等

---

## 4. 质量控制：三错即停

Worker（写代码的 AI）如果连续出错，会自动触发熔断机制：

| 阶段 | 出错次数 | 系统反应 | 人类需要做什么 |
|------|----------|----------|---------------|
| Strike 1 | 第 1 次 | 分析报错，执行修正 | 旁观 |
| Strike 2 | 第 2 次 | 停止编码，审计环境，微调方案 | 等待分析结果 |
| **Strike 3** | **第 3 次** | **熔断，停止工作，生成报告** | **必须介入决策** |

### 4.1 详细流程

**Strike 1: 初次失败**
- Worker 遇到错误或测试未通过
- 系统自动分析报错信息，定位问题，执行修正
- 建议在 30 分钟内解决

**Strike 2: 二次失败**
- Strike 1 修正后仍然失败
- 立即停止编码
- Explorer 审计环境（重新分析代码结构）
- Oracle 微调方案（调整技术方案）
- 建议在 2 小时内完成

**Strike 3: 熔断**
- Strike 2 调整后仍然失败
- Supervisor 介入，触发熔断机制
- 生成失败分析报告
- 暂停所有相关工作
- 等待用户决策

### 4.2 什么情况下会熔断？

- Worker 连续 3 次写不出正确代码
- 发现严重的架构冲突
- 测试持续失败
- 进度严重偏离预期

### 4.3 熔断后怎么办？

1. **Supervisor 生成失败报告**
   - 失败原因分析
   - 瓶颈在哪里
   - 建议的解决方案

2. **人类决策**
   - 选择建议方案继续
   - 调整需求重新设计
   - 暂停任务
   - 换其他方式实现

3. **重置后继续**
   - 错误计数清零
   - 按新方案执行

---

## 5. 关键决策点（需要人类确认）

AI 不会擅自做主，以下节点会停下来等你确认：

| 节点 | 停止点标记 | 确认内容 | 不确认会怎样 |
|------|-----------|----------|-------------|
| Analyst 完成后 | `[WAITING_FOR_REQUIREMENTS]` | 需求理解是否准确？PRD 是否完整？ | 无法进入设计阶段 |
| Prometheus 完成后 | `[WAITING_FOR_ARCHITECTURE]` | 架构设计是否合理？ | 无法进入架构审查 |
| Skeptic 完成后 | `[ARCHITECTURE_PASSED]` | 审查问题是否解决？ | 无法进入实现设计 |
| Oracle 完成后 | `[WAITING_FOR_DESIGN]` | 实现方案是否可行？ | 无法开始编码 |
| Worker 完成后 | 展示 Diff | 代码是否符合预期？ | 无法提交代码 |

---

## 6. 文档分工

### 6.1 PRD 需求文档（Analyst 写）

- **位置**：`docs/01_requirements/`
- **内容**：需求描述、用户故事、验收标准、多维度分析
- **特点**：业务导向，用户视角，可验证
- **给谁看**：产品经理、业务方、开发团队

**多维度分析包括**：
- 业务维度：业务价值、流程、规则
- 用户维度：用户画像、场景、痛点
- 功能维度：功能范围、优先级、依赖
- 技术维度：可行性、约束、集成
- 风险维度：不确定性、风险、缓解措施
- 验收维度：验收标准、成功指标

---

### 6.2 架构设计文档（Prometheus 写）

- **位置**：`docs/02_logical_workflow/`
- **内容**：伪代码、接口定义、架构决策
- **特点**：技术无关，任何语言都适用
- **给谁看**：技术负责人、架构师

---

### 6.3 实现设计文档（Oracle 写）

- **位置**：`src/模块/design.md`
- **内容**：具体实现方案、任务清单、技术选型
- **特点**：项目特定，可操作
- **给谁看**：开发工程师

---

## 7. AI 技能与指令（Skill & Prompt）

### 7.1 什么是 Skill？

**Skill** 是 AI Agent 的功能模块定义，描述特定任务的完整执行逻辑。

- **存放位置**：`sop/skills/[skill-name]/SKILL.md`
- **用途**：封装角色的核心能力，可被多个角色复用
- **格式**：包含 frontmatter（name, description）的 Markdown 文件

**示例 Skill**：
- `sop-workflow-orchestrator`：工作流编排
- `sop-requirement-analyst`：需求分析
- `sop-architecture-reviewer`：架构审查

---

### 7.2 什么是 Prompt？

**Prompt** 是直接给 AI Agent 的指令模板，用于激活特定角色。

- **存放位置**：`sop/prompts/[role]_prompt.md`
- **用途**：角色的"激活指令"
- **格式**：Markdown 文件，包含角色身份、职责、约束

**主要 Prompts**：
- `router_prompt.md`：激活 Router 角色
- `analyst_prompt.md`：激活 Analyst 角色
- `prometheus_prompt.md`：激活 Prometheus 角色
- `skeptic_prompt.md`：激活 Skeptic 角色
- `oracle_prompt.md`：激活 Oracle 角色
- `worker_prompt.md`：激活 Worker 角色

---

### 7.3 Skill vs Prompt 区别

| 特性 | Skill | Prompt |
|------|-------|--------|
| **用途** | 功能模块定义 | 角色激活指令 |
| **格式** | SKILL.md（带 frontmatter） | Markdown |
| **内容** | 完整工作流程、输入输出规范 | 角色身份、职责、约束 |
| **使用场景** | 被 AI 系统调用 | 直接发送给 AI Agent |
| **存放位置** | `skills/[name]/` | `prompts/` |
| **目标读者** | AI 系统 / 开发者 | AI Agent |

---

## 8. 快速开始指南

### 8.1 如果你是产品经理

1. **提需求时**：
   - 与 **Analyst** 对话，描述需求和目标
   - 回答 Analyst 的澄清问题
   - 提供业务背景和用户场景

2. **需求确认**：
   - 查看 **Analyst** 生成的 PRD 文档
   - 确认需求理解是否准确
   - 检查多维度分析是否完整
   - 提出调整意见

3. **等待设计**：
   - 查看 **Prometheus** 的架构设计
   - 确认是否符合产品规划
   - 提出调整意见

4. **验收时**：
   - 检查 **Worker** 的代码 Diff
   - 对照 PRD 验收功能
   - 确认功能符合需求
   - 批准合并

---

### 8.2 如果你是技术负责人

1. **任务分诊**：
   - 判断用快速模式还是深度模式
   - 分配对应的 AI 角色

2. **设计审查**：
   - 审查 Prometheus 的架构设计
   - 审查 Oracle 的实现方案
   - 确保技术选型合理

3. **代码审查**：
   - 审查 Worker 的代码
   - 确认符合规范
   - 批准合并

4. **问题处理**：
   - 熔断时做出决策
   - 调整方案或需求

---

### 8.3 如果你是开发者

1. **查看设计**：
   - 阅读 Oracle 的实现设计文档
   - 理解技术选型和接口定义
   - 明确自己的开发任务

2. **配合 AI**：
   - 提供必要的上下文信息
   - 回答 AI 的澄清问题
   - 审查 AI 生成的代码

3. **补充完善**：
   - 添加 AI 遗漏的边界情况
   - 完善测试用例
   - 更新相关文档

---

## 9. 常见问题

### Q1: 为什么要分这么多角色？

**A**: 专业化分工，每个角色专注一件事：
- **Analyst** 专注需求（与用户对话，挖掘真实需求）
- **Prometheus** 专注架构（不考虑实现细节）
- **Skeptic** 专注审查（挑刺找问题，确保质量）
- **Oracle** 专注实现（基于架构做具体方案）
- **Worker** 专注编码（不偏离设计）

这样可以提高质量，减少返工。

---

### Q2: 小改动也要走完整流程吗？

**A**: 不需要。Router 会自动判断：
- 单文件、<30 行、无逻辑变更 → 快速模式（5-30 分钟）
- 其他情况 → 深度模式

---

### Q3: 熔断是不是太严格了？

**A**: 三次机会已经很宽松了：
- 第 1 次：自动重试
- 第 2 次：重新分析
- 第 3 次：说明真的有问题，需要人类介入

这样可以避免 AI 在错误的方向上浪费大量时间。

---

### Q4: 人类需要一直盯着吗？

**A**: 不需要。AI 会在关键节点停下来等你确认，其他时间自动执行。你可以：
- 设置通知，只在需要决策时介入
- 定期查看进度报告
- 熔断时及时处理

---

### Q5: 这套规约适合什么项目？

**A**: 适合：
- 中大型项目（代码量 > 1 万行）
- 团队协作项目
- 需要长期维护的项目
- 对质量要求高的项目

不适合：
- 一次性脚本
- 个人 toy 项目
- 原型验证阶段

---

### Q6: Skill 和 Prompt 是什么？

**A**: 
- **Skill** 是 AI 的功能模块定义（如工作流编排、需求分析），面向 AI 系统
- **Prompt** 是激活 AI 角色的指令模板（如"你现在是 Analyst 角色"），面向 AI Agent

普通用户不需要关心这些，系统会自动处理。

---

## 10. 决策检查清单

### 任务开始前

- [ ] 明确需求范围和目标
- [ ] 判断用快速模式还是深度模式
- [ ] 分配对应的 AI 角色

### 设计阶段

- [ ] 审查架构设计（Prometheus）
- [ ] 审查实现方案（Oracle）
- [ ] 确认技术选型合理
- [ ] 评估风险可控

### 编码阶段

- [ ] 定期查看进度报告
- [ ] 及时处理熔断情况
- [ ] 审查代码 Diff

### 完成后

- [ ] 功能验收
- [ ] 代码合并
- [ ] 文档归档

---

## 11. 快速参考

### 11.1 场景速查

| 场景 | 推荐路径 | 主要角色 | 预计时间 |
|------|----------|----------|----------|
| 修复拼写错误 | 快速路径 | Worker | 5分钟 |
| 添加日志 | 快速路径 | Worker | 10分钟 |
| 新增功能 | 深度路径 | 全角色 | 1-3天 |
| 重构代码 | 深度路径 | 全角色 | 2-5天 |
| 架构调整 | 深度路径 | 全角色 | 1-2周 |

### 11.2 停止点速查

| 阶段 | 停止点标记 | 等待内容 |
|------|-----------|----------|
| Analyst | `[WAITING_FOR_REQUIREMENTS]` | 用户确认PRD |
| Prometheus | `[WAITING_FOR_ARCHITECTURE]` | 架构审批 |
| Skeptic | `[ARCHITECTURE_PASSED]` | 审查通过 |
| Oracle | `[WAITING_FOR_DESIGN]` | 设计审批 |
| Worker | Diff展示 | 用户审批代码 |

### 11.3 三错即停速查

| Strike | 触发条件 | 行动 | 用户干预 |
|--------|----------|------|----------|
| 1 | Worker失败 | 自动修正 | 无需 |
| 2 | 再次失败 | 审计+微调 | 等待 |
| 3 | 第三次失败 | **熔断**，生成报告 | **必须** |

---

## 12. 联系方式

如有问题或建议，请联系：

- **文档维护**: Librarian 角色
- **流程优化**: Router 角色
- **技术问题**: Explorer 角色

---

## 附录：术语表

| 术语 | 解释 |
|------|------|
| **渐进式披露** | 信息分层展示，按需获取 |
| **伪代码** | 类似代码的文字描述，不绑定具体语言 |
| **熔断** | 停止工作，等待人工决策 |
| **ADR** | Architecture Decision Record，架构决策记录 |
| **Diff** | 代码变更对比 |
| **Skill** | AI 功能模块定义 |
| **Prompt** | AI 角色激活指令 |
| **Frontmatter** | Markdown 文件头部的元数据（如 name, description） |

---

**提示**：本文档面向人类读者，如需查看 AI 执行的详细规范，请参考 `sop/` 目录下的完整文档。
